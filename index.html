<!DOCTYPE html>
<html lang="id">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Aplikasi Presensi Karyawan</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
      .clock {
        font-family: "Courier New", Courier, monospace;
        font-weight: bold;
      }
      .fade-in {
        animation: fadeIn 0.5s ease-in;
      }
      @keyframes fadeIn {
        from {
          opacity: 0;
          transform: translateY(20px);
        }
        to {
          opacity: 1;
          transform: translateY(0);
        }
      }
      .pulse-button {
        animation: pulse 2s infinite;
      }
      @keyframes pulse {
        0%,
        100% {
          transform: scale(1);
        }
        50% {
          transform: scale(1.05);
        }
      }
      .spinner {
        animation: spin 1s linear infinite;
      }
      @keyframes spin {
        from {
          transform: rotate(0deg);
        }
        to {
          transform: rotate(360deg);
        }
      }

      /* Admin tab styles */
      .admin-tab-btn.active {
        border-bottom-color: #3b82f6;
        color: #3b82f6;
      }
      .admin-tab-content {
        display: block;
      }
      .admin-tab-content.hidden {
        display: none;
      }

      /* Mobile responsive styles */
      @media (max-width: 768px) {
        .mobile-padding {
          padding: 1rem;
        }
        .mobile-text-sm {
          font-size: 0.875rem;
        }
        .mobile-text-base {
          font-size: 1rem;
        }
        .mobile-text-lg {
          font-size: 1.125rem;
        }
        .mobile-text-xl {
          font-size: 1.25rem;
        }
        .mobile-text-2xl {
          font-size: 1.5rem;
        }
        .mobile-text-3xl {
          font-size: 1.875rem;
        }
        .mobile-grid-1 {
          grid-template-columns: 1fr;
        }
        .mobile-space-y-3 > * + * {
          margin-top: 0.75rem;
        }
        .mobile-py-2 {
          padding-top: 0.5rem;
          padding-bottom: 0.5rem;
        }
        .mobile-px-3 {
          padding-left: 0.75rem;
          padding-right: 0.75rem;
        }
      }
    </style>
  </head>
  <body class="bg-gradient-to-br from-blue-50 to-indigo-100 min-h-screen">
    <!-- Login Form -->
    <div
      id="loginForm"
      class="min-h-screen flex items-center justify-center p-4 bg-red-200 mobile-padding"
    >
      <div
        class="bg-red-100 rounded-2xl shadow-2xl p-8 w-full max-w-md fade-in"
      >
        <div class="text-center mb-4">
          <div class="w-48 h-48 mx-auto mb-2">
            <img
              src="src/logo.svg"
              alt="Logo"
              class="w-full h-full object-contain"
            />
          </div>
          <h1 class="text-4xl font-bold text-gray-1000">TOP TOP TEA</h1>
          <p class="text-gray-800 mt-2">Sistem Presensi Online</p>
        </div>

        <form id="loginFormSubmit" class="space-y-6">
          <div>
            <label class="block text-sm font-medium text-black-700 mb-1"
              >User ID</label
            >
            <input
              type="text"
              id="userId"
              class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"
              placeholder="Masukkan User ID"
              required
            />
          </div>

          <div>
            <label class="block text-sm font-medium text-black-700 mb-1"
              >Password</label
            >
            <input
              type="password"
              id="password"
              class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"
              placeholder="Masukkan Password"
              required
            />
          </div>

          <button
            type="submit"
            class="w-full bg-cyan-600 text-white py-3 rounded-lg hover:bg-cyan-800 transition duration-200 font-medium"
          >
            Masuk
          </button>
          <div class="flex flex-col gap-1">
            <label class="flex justify-center">
              <label class="text-xs text-gray-500">Kode Versi 1.3.3</label>
            </label>
            <label class="flex justify-center">
              <label class="text-xs text-gray-500">Sang Pemalas </label>
            </label>
          </div>
        </form>

        <div
          id="loginError"
          class="mt-4 p-3 bg-red-100 border border-red-400 text-red-700 rounded-lg hidden"
        >
          User ID atau Password salah!
        </div>
      </div>
    </div>

    <!-- Dashboard -->
    <div id="dashboard" class="hidden min-h-screen p-4 mobile-padding">
      <div class="max-w-6xl mx-auto">
        <!-- Header -->
        <div
          class="bg-[url('src/bg.svg')] bg-cover bg-no-repeat bg-center rounded-2xl shadow-lg p-6 mb-6 fade-in mobile-px-3 mobile-py-2"
        >
          <div
            class="flex flex-col sm:flex-row justify-between items-start sm:items-center space-y-3 sm:space-y-0 relative"
          >
            <div>
              <h1
                id="userName"
                class="text-3xl mobile-text-2xl font-bold text-gray-800 mb-2"
              ></h1>
              <p
                id="userBranch"
                class="text-lg mobile-text-base text-gray-600"
              ></p>
            </div>
            <button
              onclick="logout()"
              class="bg-red-500 text-white px-4 py-2 rounded-lg hover:bg-red-600 transition duration-200 text-sm mt-3 sm-mt-0"
            >
              KELUAR
            </button>
          </div>
          <div
            class="hidden sm:block absolute right-0 top-1/2 transform -translate-y-1/2 md:static md:transform-none"
          ></div>
        </div>

        <!-- Clock and Date -->
        <div
          class="bg-red-200 rounded-2xl shadow-lg p-6 mb-6 text-center fade-in mobile-px-3 mobile-py-2"
        >
          <div
            id="currentTime"
            class="clock text-4xl mobile-text-3xl font-bold text-black-700 mb-2"
          ></div>
          <div
            id="currentDate"
            class="text-xl mobile-text-lg text-black-600"
          ></div>
        </div>

        <!-- Attendance Buttons -->
        <div class="grid md:grid-cols-2 mobile-grid-1 gap-6 mb-6">
          <div
            class="bg-white rounded-2xl shadow-lg p-6 fade-in mobile-px-3 mobile-py-2"
          >
            <h3
              class="text-xl mobile-text-lg font-bold text-gray-800 mb-4 text-center"
            >
              Presensi Harian
            </h3>
            <div class="space-y-4 mobile-space-y-3">
              <button
                onclick="clockIn()"
                class="w-full bg-green-500 text-white py-3 rounded-lg hover:bg-green-600 transition duration-200 font-medium pulse-button"
              >
                ‚úÖ Masuk
              </button>
              <button
                onclick="clockOut()"
                class="w-full bg-red-500 text-white py-3 rounded-lg hover:bg-red-600 transition duration-200 font-medium pulse-button"
              >
                ‚ùå Pulang
              </button>
            </div>
          </div>

          <div
            class="bg-white rounded-2xl shadow-lg p-6 fade-in mobile-px-3 mobile-py-2"
          >
            <h3
              class="text-xl mobile-text-lg font-bold text-gray-800 mb-4 text-center"
            >
              Keterangan Khusus
            </h3>
            <div class="space-y-4 mobile-space-y-3">
              <button
                onclick="showPermissionForm('Izin')"
                class="w-full bg-yellow-500 text-white py-3 rounded-lg hover:bg-yellow-600 transition duration-200 font-medium"
              >
                üìã Izin
              </button>
              <button
                onclick="showPermissionForm('Sakit')"
                class="w-full bg-yellow-500 text-white py-3 rounded-lg hover:bg-yellow-600 transition duration-200 font-medium"
              >
                üè• Sakit
              </button>
            </div>
          </div>
        </div>

        <!-- Weekly Attendance Summary -->
        <div
          class="bg-white rounded-2xl shadow-lg p-6 fade-in mobile-px-3 mobile-py-2"
        >
          <div class="flex justify-between items-center mb-4">
            <h3 class="text-xl mobile-text-lg font-bold text-gray-800">
              Rekap Kehadiran Minggu Ini
            </h3>
            <button
              onclick="loadWeeklyAttendance()"
              class="bg-blue-500 text-white px-3 py-1 rounded-lg hover:bg-blue-600 transition duration-200 text-sm"
            >
              üîÑ Refresh
            </button>
          </div>
          <div class="overflow-x-auto">
            <table class="w-full text-sm mobile-text-sm">
              <thead>
                <tr class="bg-gray-50">
                  <th
                    class="px-2 sm:px-4 py-2 sm:py-3 text-left font-medium text-gray-700 text-xs sm:text-sm"
                  >
                    Tanggal
                  </th>
                  <th
                    class="px-2 sm:px-4 py-2 sm:py-3 text-left font-medium text-gray-700 text-xs sm:text-sm"
                  >
                    Masuk
                  </th>
                  <th
                    class="px-2 sm:px-4 py-2 sm:py-3 text-left font-medium text-gray-700 text-xs sm:text-sm"
                  >
                    Pulang
                  </th>
                  <th
                    class="px-2 sm:px-4 py-2 sm:py-3 text-left font-medium text-gray-700 text-xs sm:text-sm"
                  >
                    Status
                  </th>
                  <th
                    class="px-2 sm:px-4 py-2 sm:py-3 text-left font-medium text-gray-700 text-xs sm:text-sm"
                  >
                    Keterangan
                  </th>
                </tr>
              </thead>
              <tbody id="attendanceTable">
                <!-- Data akan diisi oleh JavaScript -->
              </tbody>
            </table>
          </div>
        </div>
      </div>
    </div>

    <!-- Permission Modal -->
    <div
      id="permissionModal"
      class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-50"
    >
      <div class="bg-white rounded-2xl shadow-2xl p-6 w-full max-w-md">
        <h3
          id="permissionTitle"
          class="text-xl font-bold text-gray-800 mb-4"
        ></h3>
        <div class="mb-4">
          <label class="block text-sm font-medium text-gray-700 mb-2"
            >Keterangan</label
          >
          <textarea
            id="permissionNote"
            class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"
            rows="4"
            placeholder="Masukkan keterangan..."
            required
          ></textarea>
        </div>
        <div class="flex space-x-4">
          <button
            onclick="submitPermission()"
            class="flex-1 bg-blue-600 text-white py-3 rounded-lg hover:bg-blue-700 transition duration-200 font-medium"
          >
            Kirim
          </button>
          <button
            onclick="closePermissionModal()"
            class="flex-1 bg-gray-500 text-white py-3 rounded-lg hover:bg-gray-600 transition duration-200 font-medium"
          >
            Batal
          </button>
        </div>
      </div>
    </div>
    <div
      id="confirmationModal"
      class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-50"
    >
      <div
        class="bg-white rounded-2xl shadow-2xl p-6 w-full max-w-md text-center"
      >
        <h3
          id="confirmationTitle"
          class="text-xl font-bold text-gray-800 mb-4"
        ></h3>
        <div id="confirmationTime" class="text-center text-lg mb-6"></div>
        <div class="flex space-x-4">
          <button
            id="confirmYes"
            class="flex-1 bg-green-500 text-white py-3 rounded-lg hover:bg-green-600 transition duration-200 font-medium pulse-button"
          >
            Ya
          </button>
          <button
            onclick="closeConfirmationModal()"
            class="flex-1 bg-red-500 text-white py-3 rounded-lg hover:bg-red-600 transition duration-200 font-medium pulse-button"
          >
            Batal
          </button>
        </div>
      </div>
    </div>

    <!-- Sync Modal -->
    <div
      id="syncModal"
      class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-50"
    >
      <div
        class="bg-white rounded-2xl shadow-2xl p-8 text-center max-w-sm w-full"
      >
        <div
          class="spinner w-12 h-12 border-4 border-blue-200 border-t-blue-600 rounded-full mx-auto mb-4"
        ></div>
        <h3 class="text-lg font-semibold text-gray-800 mb-2">
          Sinkron Data Server
        </h3>
        <p class="text-gray-600 text-sm">Memuat data histori kehadiran...</p>
      </div>
    </div>

    <!-- Loading Modal -->
    <div
      id="loadingModal"
      class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-50"
    >
      <div
        class="bg-white rounded-2xl shadow-2xl p-8 text-center max-w-sm w-full"
      >
        <div
          class="spinner w-12 h-12 border-4 border-blue-200 border-t-blue-600 rounded-full mx-auto mb-4"
        ></div>
        <h3 class="text-lg font-semibold text-gray-800 mb-2">
          Mengirim Data...
        </h3>
        <p class="text-gray-600 text-sm">Mohon tunggu sebentar</p>
      </div>
    </div>

    <!-- Admin Dashboard -->
    <div id="adminDashboard" class="hidden min-h-screen p-4 mobile-padding">
      <div class="max-w-7xl mx-auto">
        <!-- Admin Header -->
        <div
          class="bg-[url('src/bg.svg')] bg-cover bg-no-repeat bg-center rounded-2xl shadow-lg p-6 mb-6 fade-in"
        >
          <div
            class="flex flex-col sm:flex-row justify-between items-start sm:items-center space-y-3 sm:space-y-0"
          >
            <div>
              <h1 class="text-3xl mobile-text-2xl font-bold text-gray-800 mb-2">
                Administrator
              </h1>
              <p class="text-lg mobile-text-base text-gray-600">Dashboard</p>
            </div>
            <button
              onclick="logout()"
              class="bg-red-500 text-white px-4 py-2 rounded-lg hover:bg-red-600 transition duration-200 text-sm"
            >
              KELUAR
            </button>
          </div>
        </div>

        <!-- Admin Menu Tabs -->
        <div class="bg-white rounded-2xl shadow-lg mb-6 fade-in">
          <div class="flex flex-wrap border-b border-gray-200">
            <button
              onclick="showAdminTab('today')"
              id="todayTab"
              class="admin-tab-btn active px-6 py-4 text-sm font-medium border-b-2 border-blue-500 text-blue-600"
            >
              üìä Data Hari Ini
            </button>
            <button
              onclick="showAdminTab('monthly')"
              id="monthlyTab"
              class="admin-tab-btn px-6 py-4 text-sm font-medium border-b-2 border-transparent text-gray-500 hover:text-gray-700"
            >
              üìà Rekap Bulanan
            </button>
            <button
              onclick="showAdminTab('employee')"
              id="employeeTab"
              class="admin-tab-btn px-6 py-4 text-sm font-medium border-b-2 border-transparent text-gray-500 hover:text-gray-700"
            >
              üë§ Rekap Pegawai
            </button>
          </div>

          <!-- Today's Attendance Tab -->
          <div id="todayContent" class="admin-tab-content p-6">
            <div class="flex justify-between items-center mb-4">
              <h3 class="text-xl font-bold text-gray-800">
                Data Kehadiran Hari Ini
              </h3>
              <button
                onclick="loadTodayAttendance()"
                class="bg-blue-500 text-white px-4 py-2 rounded-lg hover:bg-blue-600 transition duration-200 text-sm"
              >
                üîÑ Refresh
              </button>
            </div>
            <div class="overflow-x-auto">
              <table class="w-full text-sm">
                <thead>
                  <tr class="bg-gray-50">
                    <th class="px-4 py-3 text-left font-medium text-gray-700">
                      Nama
                    </th>
                    <th class="px-4 py-3 text-left font-medium text-gray-700">
                      Cabang
                    </th>
                    <th class="px-4 py-3 text-left font-medium text-gray-700">
                      Tanggal
                    </th>
                    <th class="px-4 py-3 text-left font-medium text-gray-700">
                      Masuk
                    </th>
                    <th class="px-4 py-3 text-left font-medium text-gray-700">
                      Pulang
                    </th>
                    <th class="px-4 py-3 text-left font-medium text-gray-700">
                      Status
                    </th>
                    <th class="px-4 py-3 text-left font-medium text-gray-700">
                      Keterangan
                    </th>
                  </tr>
                </thead>
                <tbody id="todayAttendanceTable">
                  <!-- Data akan diisi oleh JavaScript -->
                </tbody>
              </table>
            </div>
          </div>

          <!-- Monthly Report Tab -->
          <div id="monthlyContent" class="admin-tab-content hidden p-6">
            <!-- Month Filter -->
            <div class="bg-gray-50 rounded-lg p-4 mb-6">
              <div
                class="flex flex-col sm:flex-row justify-between items-start sm:items-center space-y-3 sm:space-y-0"
              >
                <h4 class="text-lg font-semibold text-gray-800">
                  Rekap Kehadiran Bulanan
                </h4>
                <div class="flex items-center space-x-3">
                  <label class="text-sm font-medium text-gray-700"
                    >Bulan:</label
                  >
                  <input
                    type="month"
                    id="monthFilter"
                    class="px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500"
                    onchange="loadMonthlyReport()"
                  />
                  <button
                    onclick="loadMonthlyReport()"
                    class="bg-blue-500 text-white px-4 py-2 rounded-lg hover:bg-blue-600 transition duration-200 text-sm"
                  >
                    üîÑ Refresh
                  </button>
                </div>
              </div>
            </div>

            <!-- Monthly Report Cards -->
            <div
              id="monthlyReportCards"
              class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-6"
            >
              <!-- Cards akan diisi oleh JavaScript -->
            </div>
          </div>

          <!-- Employee Report Tab -->
          <div id="employeeContent" class="admin-tab-content hidden p-6">
            <!-- Employee Filter -->
            <div class="bg-gray-50 rounded-lg p-4 mb-6">
              <h4 class="text-lg font-semibold text-gray-800 mb-4">
                Filter Pegawai
              </h4>
              <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                <div>
                  <label class="block text-sm font-medium text-gray-700 mb-2"
                    >Nama Pegawai</label
                  >
                  <select
                    id="employeeReportFilter"
                    class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500"
                  >
                    <option value="">Pilih Pegawai</option>
                    <!-- Options akan diisi oleh JavaScript -->
                  </select>
                </div>
                <div>
                  <label class="block text-sm font-medium text-gray-700 mb-2"
                    >Bulan</label
                  >
                  <input
                    type="month"
                    id="employeeMonthFilter"
                    class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500"
                  />
                </div>
              </div>
              <div class="mt-4">
                <button
                  onclick="loadEmployeeReport()"
                  class="bg-blue-500 text-white px-6 py-2 rounded-lg hover:bg-blue-600 transition duration-200"
                >
                  üîç Tampilkan Data
                </button>
              </div>
            </div>

            <!-- Employee Report Table -->
            <div class="bg-white rounded-lg shadow-lg overflow-hidden">
              <div class="px-6 py-4 border-b border-gray-200">
                <h3
                  id="employeeReportTitle"
                  class="text-xl font-bold text-gray-800"
                >
                  Rekap Kehadiran Pegawai
                </h3>
              </div>
              <div class="overflow-x-auto">
                <table class="w-full text-sm">
                  <thead class="bg-gray-50">
                    <tr>
                      <th class="px-4 py-3 text-left font-medium text-gray-700">
                        Tanggal
                      </th>
                      <th class="px-4 py-3 text-left font-medium text-gray-700">
                        Hari
                      </th>
                      <th class="px-4 py-3 text-left font-medium text-gray-700">
                        Masuk
                      </th>
                      <th class="px-4 py-3 text-left font-medium text-gray-700">
                        Pulang
                      </th>
                      <th class="px-4 py-3 text-left font-medium text-gray-700">
                        Status
                      </th>
                      <th class="px-4 py-3 text-left font-medium text-gray-700">
                        Keterangan
                      </th>
                    </tr>
                  </thead>
                  <tbody id="employeeReportTable">
                    <tr>
                      <td colspan="6" class="text-center py-8 text-gray-500">
                        Pilih pegawai dan bulan untuk melihat data
                      </td>
                    </tr>
                  </tbody>
                </table>
              </div>
            </div>

            <!-- Summary Statistics -->
            <div
              id="employeeSummary"
              class="hidden mt-6 grid grid-cols-1 md:grid-cols-4 gap-4"
            >
              <div class="bg-green-50 rounded-lg p-4 text-center">
                <div
                  class="text-2xl font-bold text-green-600"
                  id="summaryHadir"
                >
                  0
                </div>
                <div class="text-sm text-gray-600">Hari Hadir</div>
              </div>
              <div class="bg-yellow-50 rounded-lg p-4 text-center">
                <div
                  class="text-2xl font-bold text-yellow-600"
                  id="summaryIzin"
                >
                  0
                </div>
                <div class="text-sm text-gray-600">Hari Izin</div>
              </div>
              <div class="bg-red-50 rounded-lg p-4 text-center">
                <div class="text-2xl font-bold text-red-600" id="summarySakit">
                  0
                </div>
                <div class="text-sm text-gray-600">Hari Sakit</div>
              </div>
              <div class="bg-blue-50 rounded-lg p-4 text-center">
                <div class="text-2xl font-bold text-blue-600" id="summaryTotal">
                  0
                </div>
                <div class="text-sm text-gray-600">Total Hari</div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Success Message -->
    <div
      id="successMessage"
      class="hidden fixed top-4 right-4 bg-green-500 text-white px-6 py-3 rounded-lg shadow-lg z-50"
    >
      Data berhasil dikirim!
    </div>

    <!-- Load external data files -->
    <script src="data-pegawai.js"></script>
    <script src="data-cabang.js"></script>
    <script src="app.js"></script>
    <script>
      // Aplikasi Presensi Karyawan - Main JavaScript File

      let currentUser = null;
      let currentPermissionType = "";

      // Google Sheets configuration
      const SHEET_ID = "1mkNKEqZ2dqVqU_kk5I2hyecCEf-rlNevEjw4QDvgmuY";
      const SHEET_NAME = "Kehadiran";
      const APPS_SCRIPT_URL =
        "https://script.google.com/macros/s/AKfycbzYPal7F5_VZ1ThN9uzgoFIzDnxbY0bpZMrazt0tQdnXGqvkXbLYJwV6Vw3D99tBBxI/exec";

      // Initialize application when page loads
      document.addEventListener("DOMContentLoaded", function () {
        initializeApp();
      });

      function initializeApp() {
        // Populate employee dropdown in admin panel
        populateEmployeeDropdown();

        // Set up login form
        document
          .getElementById("loginFormSubmit")
          .addEventListener("submit", handleLogin);

        // Start clock
        updateClock();
        setInterval(updateClock, 1000);
        document
          .getElementById("confirmYes")
          .addEventListener("click", confirmAction);
      }

      // Fungsi untuk menampilkan modal konfirmasi
      function showConfirmationModal(type) {
        const now = new Date();
        const timeString = formatTime(now);
        const dateString = formatDate(now);
        const fullDateTime = `${dateString} ${timeString}`;

        document.getElementById(
          "confirmationTitle"
        ).textContent = `Apakah kamu yakin mengirimkan data ${type} Sekarang?`;
        document.getElementById("confirmationTime").textContent = fullDateTime;
        document.getElementById("confirmationModal").classList.remove("hidden");
      }

      // Fungsi untuk menutup modal konfirmasi
      function closeConfirmationModal() {
        document.getElementById("confirmationModal").classList.add("hidden");
      }

      // Fungsi yang akan dipanggil ketika tombol Ya diklik
      function confirmAction() {
        closeConfirmationModal();
        showLoadingModal();

        const now = new Date();
        const timeString = formatTime(now);
        const dateString = formatDate(now);

        if (currentConfirmationType === "Masuk") {
          sendToGoogleSheets({
            Nama: currentUser.nama,
            Cabang: currentUser.cabang,
            Tanggal: dateString,
            Masuk: timeString,
          });
        } else if (currentConfirmationType === "Pulang") {
          sendToGoogleSheets({
            Nama: currentUser.nama,
            Cabang: currentUser.cabang,
            Tanggal: dateString,
            Pulang: timeString,
          });
        }
      }
      // Populate employee dropdown for admin reports
      function populateEmployeeDropdown() {
        const dropdown = document.getElementById("employeeReportFilter");
        if (dropdown) {
          // Clear existing options except the first one
          dropdown.innerHTML = '<option value="">Pilih Pegawai</option>';

          // Add all active employees
          const allPegawai = getAllPegawai();
          allPegawai.forEach((pegawai) => {
            const option = document.createElement("option");
            option.value = pegawai.nama;
            option.textContent = `${pegawai.nama} - ${getNamaCabang(
              pegawai.cabangId
            )}`;
            dropdown.appendChild(option);
          });
        }
      }

      // Login functionality
      function handleLogin(e) {
        e.preventDefault();
        const userId = document.getElementById("userId").value;
        const password = document.getElementById("password").value;

        const pegawai = getPegawaiByUserId(userId);

        if (
          pegawai &&
          pegawai.password === password &&
          pegawai.status === "Aktif"
        ) {
          currentUser = {
            id: userId,
            nama: pegawai.nama,
            cabangId: pegawai.cabangId,
            cabang: getNamaCabang(pegawai.cabangId),
            jabatan: pegawai.jabatan,
            isAdmin: pegawai.isAdmin || false,
          };
          showDashboard();
        } else {
          document.getElementById("loginError").classList.remove("hidden");
          setTimeout(() => {
            document.getElementById("loginError").classList.add("hidden");
          }, 3000);
        }
      }

      function showDashboard() {
        document.getElementById("loginForm").classList.add("hidden");

        if (currentUser.isAdmin) {
          // Show admin dashboard
          document.getElementById("adminDashboard").classList.remove("hidden");
          updateClock();

          // Set default month filter to current month
          const now = new Date();
          const currentMonth =
            now.getFullYear() +
            "-" +
            String(now.getMonth() + 1).padStart(2, "0");
          document.getElementById("monthFilter").value = currentMonth;
          document.getElementById("employeeMonthFilter").value = currentMonth;

          // Load today's attendance by default
          loadTodayAttendance();

          // Auto-refresh today's data every 30 seconds
          setInterval(() => {
            if (currentUser && currentUser.isAdmin) {
              loadTodayAttendance();
            }
          }, 30000);
        } else {
          // Show employee dashboard
          document.getElementById("dashboard").classList.remove("hidden");
          document.getElementById("userName").textContent = currentUser.nama;
          document.getElementById("userBranch").textContent =
            currentUser.cabang;
          updateClock();

          // Show sync modal and load data
          showSyncModal();
          loadWeeklyAttendance();

          // Auto-refresh attendance data every 30 seconds
          setInterval(() => {
            if (currentUser && !currentUser.isAdmin) {
              loadWeeklyAttendance();
            }
          }, 30000);
        }
      }

      function logout() {
        currentUser = null;
        document.getElementById("dashboard").classList.add("hidden");
        document.getElementById("adminDashboard").classList.add("hidden");
        document.getElementById("loginForm").classList.remove("hidden");
        document.getElementById("userId").value = "";
        document.getElementById("password").value = "";
      }

      // Clock functionality
      function updateClock() {
        const now = new Date();
        const timeOptions = {
          timeZone: "Asia/Jakarta",
          hour12: false,
          hour: "2-digit",
          minute: "2-digit",
          second: "2-digit",
        };
        const dateOptions = {
          timeZone: "Asia/Jakarta",
          weekday: "long",
          year: "numeric",
          month: "long",
          day: "numeric",
        };

        const timeElement = document.getElementById("currentTime");
        const dateElement = document.getElementById("currentDate");

        if (timeElement) {
          timeElement.textContent = now.toLocaleTimeString(
            "id-ID",
            timeOptions
          );
        }
        if (dateElement) {
          dateElement.textContent = now.toLocaleDateString(
            "id-ID",
            dateOptions
          );
        }
      }

      // Format functions for consistent date and time display
      function formatTime(date) {
        const hours = date.getHours().toString().padStart(2, "0");
        const minutes = date.getMinutes().toString().padStart(2, "0");
        return `${hours}:${minutes}`;
      }

      function formatDate(date) {
        const day = date.getDate().toString().padStart(2, "0");
        const month = (date.getMonth() + 1).toString().padStart(2, "0");
        const year = date.getFullYear();
        return `${day}/${month}/${year}`;
      }

      function clockIn() {
        currentConfirmationType = "Masuk";
        showConfirmationModal("Masuk");
      }

      function clockOut() {
        currentConfirmationType = "Pulang";
        showConfirmationModal("Pulang");
      }

      function showPermissionForm(type) {
        currentPermissionType = type;
        document.getElementById("permissionTitle").textContent = `Form ${type}`;
        document.getElementById("permissionModal").classList.remove("hidden");
        document.getElementById("permissionNote").focus();
      }

      function closePermissionModal() {
        document.getElementById("permissionModal").classList.add("hidden");
        document.getElementById("permissionNote").value = "";
      }

      function submitPermission() {
        const note = document.getElementById("permissionNote").value.trim();
        if (!note) {
          alert("Harap isi keterangan terlebih dahulu!");
          return;
        }

        closePermissionModal();
        showLoadingModal();

        const now = new Date();
        const dateString = formatDate(now);

        sendToGoogleSheets({
          Nama: currentUser.nama,
          Cabang: currentUser.cabang,
          Tanggal: dateString,
          Status: currentPermissionType,
          Keterangan: note,
        });
      }

      // Modal functions
      function showSyncModal() {
        document.getElementById("syncModal").classList.remove("hidden");
      }

      function hideSyncModal() {
        document.getElementById("syncModal").classList.add("hidden");
      }

      function showLoadingModal() {
        document.getElementById("loadingModal").classList.remove("hidden");
      }

      function hideLoadingModal() {
        document.getElementById("loadingModal").classList.add("hidden");
      }

      // Google Sheets integration
      async function sendToGoogleSheets(data) {
        try {
          console.log("Data yang akan dikirim:", data);

          // Create form data for POST request
          const formData = new FormData();
          Object.keys(data).forEach((key) => {
            if (data[key] !== undefined && data[key] !== null) {
              formData.append(key, data[key]);
            }
          });

          const response = await fetch(APPS_SCRIPT_URL, {
            method: "POST",
            body: formData,
          });

          const result = await response.text();
          console.log("Response:", result);

          hideLoadingModal();

          if (result.includes("berhasil")) {
            showSuccessMessage();
            // Update tabel rekap
            setTimeout(() => {
              loadWeeklyAttendance();
            }, 500);
          } else {
            showErrorMessage("Gagal mengirim data: " + result);
          }
        } catch (error) {
          console.error("Error:", error);
          hideLoadingModal();
          showErrorMessage(
            "Terjadi kesalahan saat mengirim data. Periksa koneksi internet Anda."
          );
        }
      }

      function showSuccessMessage(message = "Data berhasil dikirim!") {
        const successMsg = document.getElementById("successMessage");
        successMsg.textContent = message;
        successMsg.classList.remove("hidden");
        setTimeout(() => {
          successMsg.classList.add("hidden");
        }, 3000);
      }

      function showErrorMessage(errorText) {
        // Create error message element if it doesn't exist
        let errorMessage = document.getElementById("errorMessage");
        if (!errorMessage) {
          errorMessage = document.createElement("div");
          errorMessage.id = "errorMessage";
          errorMessage.className =
            "fixed top-4 right-4 bg-red-500 text-white px-6 py-3 rounded-lg shadow-lg z-50";
          document.body.appendChild(errorMessage);
        }

        errorMessage.textContent = errorText;
        errorMessage.classList.remove("hidden");
        setTimeout(() => {
          errorMessage.classList.add("hidden");
        }, 5000);
      }

      // Weekly attendance summary - Real-time from Google Sheets
      async function loadWeeklyAttendance() {
        const tableBody = document.getElementById("attendanceTable");

        try {
          // Show loading state
          tableBody.innerHTML =
            '<tr><td colspan="5" class="text-center py-4 text-gray-500">Memuat data...</td></tr>';

          // Fetch data from Google Sheets URL directly
          const sheetUrl = `https://docs.google.com/spreadsheets/d/${SHEET_ID}/gviz/tq?tqx=out:csv&sheet=${SHEET_NAME}`;
          const response = await fetch(sheetUrl);
          const csvText = await response.text();

          // Parse CSV data
          const rows = csvText.split("\n").map((row) => {
            // Simple CSV parsing - handle quoted values
            const result = [];
            let current = "";
            let inQuotes = false;

            for (let i = 0; i < row.length; i++) {
              const char = row[i];
              if (char === '"') {
                inQuotes = !inQuotes;
              } else if (char === "," && !inQuotes) {
                result.push(current.trim());
                current = "";
              } else {
                current += char;
              }
            }
            result.push(current.trim());
            return result;
          });

          if (rows.length > 1) {
            // Clear loading state
            tableBody.innerHTML = "";

            // Filter data for current user and last 7 days
            const userAttendance = filterUserAttendanceLastWeek(rows);

            if (userAttendance.length > 0) {
              userAttendance.forEach((record) => {
                const row = document.createElement("tr");
                row.className = "border-b border-gray-200 hover:bg-gray-50";
                row.innerHTML = `
                                <td class="px-2 sm:px-4 py-2 sm:py-3 text-xs sm:text-sm">${
                                  record.tanggal
                                }</td>
                                <td class="px-2 sm:px-4 py-2 sm:py-3 text-xs sm:text-sm">${
                                  record.masuk || "-"
                                }</td>
                                <td class="px-2 sm:px-4 py-2 sm:py-3 text-xs sm:text-sm">${
                                  record.pulang || "-"
                                }</td>
                                <td class="px-2 sm:px-4 py-2 sm:py-3">
                                    <span class="px-1 sm:px-2 py-1 rounded-full text-xs font-medium ${getStatusColor(
                                      record.status
                                    )}">
                                        ${record.status}
                                    </span>
                                </td>
                                <td class="px-2 sm:px-4 py-2 sm:py-3 text-xs sm:text-sm">${
                                  record.keterangan || "-"
                                }</td>
                            `;
                tableBody.appendChild(row);
              });
            } else {
              tableBody.innerHTML =
                '<tr><td colspan="5" class="text-center py-4 text-gray-500">Belum ada data kehadiran minggu ini</td></tr>';
            }
          } else {
            tableBody.innerHTML =
              '<tr><td colspan="5" class="text-center py-4 text-gray-500">Belum ada data kehadiran</td></tr>';
          }

          // Hide sync modal after loading
          hideSyncModal();
        } catch (error) {
          console.error("Error loading attendance data:", error);
          tableBody.innerHTML =
            '<tr><td colspan="5" class="text-center py-4 text-red-500">Error memuat data. Periksa koneksi internet.</td></tr>';

          // Hide sync modal even on error
          hideSyncModal();
        }
      }

      // Filter attendance data for current user and last 7 days
      function filterUserAttendanceLastWeek(data) {
        if (!data || data.length <= 1) return []; // Skip header row

        const today = new Date();
        const weekAgo = new Date(today.getTime() - 7 * 24 * 60 * 60 * 1000);

        // Skip header row (index 0) and filter data
        const filteredData = data.slice(1).filter((row) => {
          if (!row || row.length < 7) return false;

          const [nama, cabang, tanggal, masuk, pulang, status, keterangan] =
            row;

          // Check if this record belongs to current user
          if (nama !== currentUser.nama) return false;

          // Parse date and check if it's within last 7 days
          try {
            const recordDate = parseIndonesianDate(tanggal);
            return recordDate >= weekAgo && recordDate <= today;
          } catch (e) {
            console.error("Error parsing date:", tanggal, e);
            return false;
          }
        });

        // Group by date and merge clock in/out times
        const groupedByDate = {};

        filteredData.forEach((row) => {
          const [nama, cabang, tanggal, masuk, pulang, status, keterangan] =
            row;

          if (!groupedByDate[tanggal]) {
            groupedByDate[tanggal] = {
              tanggal: tanggal,
              masuk: "",
              pulang: "",
              status: status || "",
              keterangan: keterangan || "",
            };
          }

          // Prioritize permission status (Izin/Sakit) over attendance times
          if (
            status &&
            (status.trim() === "Izin" || status.trim() === "Sakit")
          ) {
            groupedByDate[tanggal].status = status;
            groupedByDate[tanggal].keterangan =
              keterangan || groupedByDate[tanggal].keterangan;
            // Clear any existing masuk/pulang times if permission is set
            groupedByDate[tanggal].masuk = "";
            groupedByDate[tanggal].pulang = "";
            return;
          }

          // Only update masuk/pulang times if no permission status is already set
          if (
            groupedByDate[tanggal].status !== "Izin" &&
            groupedByDate[tanggal].status !== "Sakit"
          ) {
            // Update masuk time if provided
            if (masuk && masuk.trim() !== "") {
              groupedByDate[tanggal].masuk = masuk;
            }

            // Update pulang time if provided
            if (pulang && pulang.trim() !== "") {
              groupedByDate[tanggal].pulang = pulang;
            }

            // Update status and keterangan (prioritize non-empty values)
            if (status && status.trim() !== "") {
              groupedByDate[tanggal].status = status;
            }
            if (keterangan && keterangan.trim() !== "") {
              groupedByDate[tanggal].keterangan = keterangan;
            }

            // Auto-set status to "Hadir" if both masuk and pulang times exist
            if (
              groupedByDate[tanggal].masuk &&
              groupedByDate[tanggal].pulang &&
              groupedByDate[tanggal].masuk.trim() !== "" &&
              groupedByDate[tanggal].pulang.trim() !== ""
            ) {
              groupedByDate[tanggal].status = "Hadir";
            }
          }
        });

        // Convert to array and sort by date
        return Object.values(groupedByDate).sort((a, b) => {
          try {
            const dateA = parseIndonesianDate(a.tanggal);
            const dateB = parseIndonesianDate(b.tanggal);
            return dateB - dateA; // Sort descending (newest first)
          } catch (e) {
            return 0;
          }
        });
      }

      // Parse date format (DD/MM/YYYY)
      function parseIndonesianDate(dateString) {
        if (!dateString) return new Date();

        const parts = dateString.split("/");
        if (parts.length !== 3) return new Date();

        const day = parseInt(parts[0], 10);
        const month = parseInt(parts[1], 10) - 1; // Month is 0-indexed
        const year = parseInt(parts[2], 10);

        return new Date(year, month, day);
      }

      function getStatusColor(status) {
        switch (status) {
          case "Hadir":
            return "bg-green-100 text-green-800";
          case "Izin":
            return "bg-yellow-100 text-yellow-800";
          case "Sakit":
            return "bg-red-100 text-red-800";
          default:
            return "bg-gray-100 text-gray-800";
        }
      }

      // Admin Functions
      function showAdminTab(tabName) {
        // Hide all tab contents
        document.querySelectorAll(".admin-tab-content").forEach((content) => {
          content.classList.add("hidden");
        });

        // Remove active class from all tabs
        document.querySelectorAll(".admin-tab-btn").forEach((btn) => {
          btn.classList.remove("active", "border-blue-500", "text-blue-600");
          btn.classList.add("border-transparent", "text-gray-500");
        });

        // Show selected tab content
        document.getElementById(tabName + "Content").classList.remove("hidden");

        // Add active class to selected tab
        const activeTab = document.getElementById(tabName + "Tab");
        activeTab.classList.add("active", "border-blue-500", "text-blue-600");
        activeTab.classList.remove("border-transparent", "text-gray-500");

        // Auto-load data when switching to monthly tab
        if (tabName === "monthly") {
          loadMonthlyReport();
        }
      }

      async function loadTodayAttendance() {
        const tableBody = document.getElementById("todayAttendanceTable");

        try {
          tableBody.innerHTML =
            '<tr><td colspan="7" class="text-center py-4 text-gray-500">Memuat data...</td></tr>';

          const sheetUrl = `https://docs.google.com/spreadsheets/d/${SHEET_ID}/gviz/tq?tqx=out:csv&sheet=${SHEET_NAME}`;
          const response = await fetch(sheetUrl);
          const csvText = await response.text();

          const rows = csvText.split("\n").map((row) => {
            const result = [];
            let current = "";
            let inQuotes = false;

            for (let i = 0; i < row.length; i++) {
              const char = row[i];
              if (char === '"') {
                inQuotes = !inQuotes;
              } else if (char === "," && !inQuotes) {
                result.push(current.trim());
                current = "";
              } else {
                current += char;
              }
            }
            result.push(current.trim());
            return result;
          });

          if (rows.length > 1) {
            const today = formatDate(new Date());
            const todayData = filterTodayAttendance(rows, today);

            tableBody.innerHTML = "";

            if (todayData.length > 0) {
              todayData.forEach((record) => {
                const row = document.createElement("tr");
                row.className = "border-b border-gray-200 hover:bg-gray-50";
                row.innerHTML = `
                                <td class="px-4 py-3 text-sm">${
                                  record.nama
                                }</td>
                                <td class="px-4 py-3 text-sm">${
                                  record.cabang
                                }</td>
                                <td class="px-4 py-3 text-sm">${
                                  record.tanggal
                                }</td>
                                <td class="px-4 py-3 text-sm">${
                                  record.masuk || "-"
                                }</td>
                                <td class="px-4 py-3 text-sm">${
                                  record.pulang || "-"
                                }</td>
                                <td class="px-4 py-3">
                                    <span class="px-2 py-1 rounded-full text-xs font-medium ${getStatusColor(
                                      record.status
                                    )}">
                                        ${record.status || "-"}
                                    </span>
                                </td>
                                <td class="px-4 py-3 text-sm">${
                                  record.keterangan || "-"
                                }</td>
                            `;
                tableBody.appendChild(row);
              });
            } else {
              tableBody.innerHTML =
                '<tr><td colspan="7" class="text-center py-4 text-gray-500">Belum ada data kehadiran hari ini</td></tr>';
            }
          } else {
            tableBody.innerHTML =
              '<tr><td colspan="7" class="text-center py-4 text-gray-500">Tidak ada data tersedia</td></tr>';
          }
        } catch (error) {
          console.error("Error loading today attendance:", error);
          tableBody.innerHTML =
            '<tr><td colspan="7" class="text-center py-4 text-red-500">Error memuat data</td></tr>';
        }
      }

      function filterTodayAttendance(data, today) {
        if (!data || data.length <= 1) return [];

        const filteredData = data.slice(1).filter((row) => {
          if (!row || row.length < 7) return false;
          const [nama, cabang, tanggal] = row;
          return tanggal === today;
        });

        const groupedByEmployee = {};

        filteredData.forEach((row) => {
          const [nama, cabang, tanggal, masuk, pulang, status, keterangan] =
            row;
          const key = `${nama}-${cabang}`;

          if (!groupedByEmployee[key]) {
            groupedByEmployee[key] = {
              nama: nama,
              cabang: cabang,
              tanggal: tanggal,
              masuk: "",
              pulang: "",
              status: status || "",
              keterangan: keterangan || "",
            };
          }

          // Prioritize permission status (Izin/Sakit) over attendance times
          if (
            status &&
            (status.trim() === "Izin" || status.trim() === "Sakit")
          ) {
            groupedByEmployee[key].status = status;
            groupedByEmployee[key].keterangan =
              keterangan || groupedByEmployee[key].keterangan;
            // Clear any existing masuk/pulang times if permission is set
            groupedByEmployee[key].masuk = "";
            groupedByEmployee[key].pulang = "";
            return;
          }

          // Only update masuk/pulang times if no permission status is already set
          if (
            groupedByEmployee[key].status !== "Izin" &&
            groupedByEmployee[key].status !== "Sakit"
          ) {
            if (masuk && masuk.trim() !== "") {
              groupedByEmployee[key].masuk = masuk;
            }
            if (pulang && pulang.trim() !== "") {
              groupedByEmployee[key].pulang = pulang;
            }
            if (status && status.trim() !== "") {
              groupedByEmployee[key].status = status;
            }
            if (keterangan && keterangan.trim() !== "") {
              groupedByEmployee[key].keterangan = keterangan;
            }

            // Auto-set status to "Hadir" if both times exist
            if (
              groupedByEmployee[key].masuk &&
              groupedByEmployee[key].pulang &&
              groupedByEmployee[key].masuk.trim() !== "" &&
              groupedByEmployee[key].pulang.trim() !== ""
            ) {
              groupedByEmployee[key].status = "Hadir";
            }
          }
        });

        return Object.values(groupedByEmployee);
      }

      async function loadMonthlyReport() {
        const cardsContainer = document.getElementById("monthlyReportCards");
        const monthFilter = document.getElementById("monthFilter").value;

        // If no month selected, use current month
        if (!monthFilter) {
          const now = new Date();
          const currentMonth =
            now.getFullYear() +
            "-" +
            String(now.getMonth() + 1).padStart(2, "0");
          document.getElementById("monthFilter").value = currentMonth;
        }

        const selectedMonth = document.getElementById("monthFilter").value;

        try {
          cardsContainer.innerHTML =
            '<div class="col-span-full text-center py-8 text-gray-500">Memuat data...</div>';

          const sheetUrl = `https://docs.google.com/spreadsheets/d/${SHEET_ID}/gviz/tq?tqx=out:csv&sheet=${SHEET_NAME}`;
          const response = await fetch(sheetUrl);
          const csvText = await response.text();

          const rows = csvText.split("\n").map((row) => {
            const result = [];
            let current = "";
            let inQuotes = false;

            for (let i = 0; i < row.length; i++) {
              const char = row[i];
              if (char === '"') {
                inQuotes = !inQuotes;
              } else if (char === "," && !inQuotes) {
                result.push(current.trim());
                current = "";
              } else {
                current += char;
              }
            }
            result.push(current.trim());
            return result;
          });

          if (rows.length > 1) {
            // Show all employees and all branches for the selected month
            const summaryData = generateMonthlySummary(
              rows,
              "",
              "",
              selectedMonth
            );

            cardsContainer.innerHTML = "";

            if (summaryData.length > 0) {
              summaryData.forEach((employee) => {
                const card = document.createElement("div");
                card.className =
                  "bg-white rounded-xl shadow-lg p-6 hover:shadow-xl transition-shadow duration-300";
                card.innerHTML = `
                                <div class="flex items-center mb-4">
                                    <div class="bg-blue-100 rounded-full p-3 mr-4">
                                        <svg class="w-6 h-6 text-blue-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"></path>
                                        </svg>
                                    </div>
                                    <div>
                                        <h3 class="text-lg font-bold text-gray-800">${employee.nama}</h3>
                                        <p class="text-sm text-gray-600">${employee.cabang}</p>
                                    </div>
                                </div>
                                
                                <div class="space-y-3">
                                    <div class="flex justify-between items-center p-3 bg-green-50 rounded-lg">
                                        <div class="flex items-center">
                                            <div class="w-3 h-3 bg-green-500 rounded-full mr-3"></div>
                                            <span class="text-sm font-medium text-gray-700">Hadir</span>
                                        </div>
                                        <span class="text-lg font-bold text-green-600">${employee.hadir}</span>
                                    </div>
                                    
                                    <div class="flex justify-between items-center p-3 bg-yellow-50 rounded-lg">
                                        <div class="flex items-center">
                                            <div class="w-3 h-3 bg-yellow-500 rounded-full mr-3"></div>
                                            <span class="text-sm font-medium text-gray-700">Izin</span>
                                        </div>
                                        <span class="text-lg font-bold text-yellow-600">${employee.izin}</span>
                                    </div>
                                    
                                    <div class="flex justify-between items-center p-3 bg-red-50 rounded-lg">
                                        <div class="flex items-center">
                                            <div class="w-3 h-3 bg-red-500 rounded-full mr-3"></div>
                                            <span class="text-sm font-medium text-gray-700">Sakit</span>
                                        </div>
                                        <span class="text-lg font-bold text-red-600">${employee.sakit}</span>
                                    </div>
                                </div>
                                
                                <div class="mt-4 pt-4 border-t border-gray-200">
                                    <div class="flex justify-between text-sm text-gray-600">
                                        <span>Total Hari</span>
                                        <span class="font-semibold">${employee.total}</span>
                                    </div>
                                </div>
                            `;
                cardsContainer.appendChild(card);
              });
            } else {
              cardsContainer.innerHTML =
                '<div class="col-span-full text-center py-8 text-gray-500">Tidak ada data untuk bulan yang dipilih</div>';
            }
          } else {
            cardsContainer.innerHTML =
              '<div class="col-span-full text-center py-8 text-gray-500">Tidak ada data tersedia</div>';
          }
        } catch (error) {
          console.error("Error loading monthly report:", error);
          cardsContainer.innerHTML =
            '<div class="col-span-full text-center py-8 text-red-500">Error memuat data</div>';
        }
      }

      function generateMonthlySummary(
        data,
        employeeFilter,
        branchFilter,
        monthFilter
      ) {
        if (!data || data.length <= 1) return [];

        const [year, month] = monthFilter.split("-");

        // Get all employees from data files
        const allPegawai = getAllPegawai();

        // Filter employees based on filters
        let employeesToShow = allPegawai;
        if (employeeFilter) {
          employeesToShow = allPegawai.filter(
            (emp) => emp.nama === employeeFilter
          );
        }
        if (branchFilter) {
          employeesToShow = employeesToShow.filter(
            (emp) => getNamaCabang(emp.cabangId) === branchFilter
          );
        }

        // Filter data by month
        const filteredData = data.slice(1).filter((row) => {
          if (!row || row.length < 7) return false;

          const [nama, cabang, tanggal] = row;

          // Filter by month
          try {
            const recordDate = parseIndonesianDate(tanggal);
            const recordYear = recordDate.getFullYear();
            const recordMonth = recordDate.getMonth() + 1;

            return recordYear == year && recordMonth == month;
          } catch (e) {
            return false;
          }
        });

        // Group by employee and date, then merge records
        const groupedByDateEmployee = {};

        filteredData.forEach((row) => {
          const [nama, cabang, tanggal, masuk, pulang, status, keterangan] =
            row;
          const key = `${nama}-${tanggal}`;

          if (!groupedByDateEmployee[key]) {
            groupedByDateEmployee[key] = {
              nama: nama,
              cabang: cabang,
              tanggal: tanggal,
              masuk: "",
              pulang: "",
              status: status || "",
              keterangan: keterangan || "",
            };
          }

          // Prioritize permission status (Izin/Sakit) over attendance times
          if (
            status &&
            (status.trim() === "Izin" || status.trim() === "Sakit")
          ) {
            groupedByDateEmployee[key].status = status;
            groupedByDateEmployee[key].keterangan =
              keterangan || groupedByDateEmployee[key].keterangan;
            // Clear any existing masuk/pulang times if permission is set
            groupedByDateEmployee[key].masuk = "";
            groupedByDateEmployee[key].pulang = "";
            return;
          }

          // Only update masuk/pulang times if no permission status is already set
          if (
            groupedByDateEmployee[key].status !== "Izin" &&
            groupedByDateEmployee[key].status !== "Sakit"
          ) {
            if (masuk && masuk.trim() !== "") {
              groupedByDateEmployee[key].masuk = masuk;
            }
            if (pulang && pulang.trim() !== "") {
              groupedByDateEmployee[key].pulang = pulang;
            }
            if (status && status.trim() !== "") {
              groupedByDateEmployee[key].status = status;
            }
            if (keterangan && keterangan.trim() !== "") {
              groupedByDateEmployee[key].keterangan = keterangan;
            }

            // Auto-set status to "Hadir" if both times exist
            if (
              groupedByDateEmployee[key].masuk &&
              groupedByDateEmployee[key].pulang &&
              groupedByDateEmployee[key].masuk.trim() !== "" &&
              groupedByDateEmployee[key].pulang.trim() !== ""
            ) {
              groupedByDateEmployee[key].status = "Hadir";
            }
          }
        });

        // Generate summary for each employee
        const summaryData = employeesToShow.map((pegawai) => {
          const employeeName = pegawai.nama;
          const employeeBranch = getNamaCabang(pegawai.cabangId);

          // Get all records for this employee
          const employeeRecords = Object.values(groupedByDateEmployee).filter(
            (record) => record.nama === employeeName
          );

          // Count attendance types
          let hadir = 0;
          let izin = 0;
          let sakit = 0;

          employeeRecords.forEach((record) => {
            const status = record.status || "";
            if (status === "Hadir") {
              hadir++;
            } else if (status === "Izin") {
              izin++;
            } else if (status === "Sakit") {
              sakit++;
            }
          });

          const total = hadir + izin + sakit;

          return {
            nama: employeeName,
            cabang: employeeBranch,
            hadir: hadir,
            izin: izin,
            sakit: sakit,
            total: total,
          };
        });

        return summaryData;
      }

      async function loadEmployeeReport() {
        const employeeName = document.getElementById(
          "employeeReportFilter"
        ).value;
        const monthFilter = document.getElementById(
          "employeeMonthFilter"
        ).value;
        const tableBody = document.getElementById("employeeReportTable");
        const titleElement = document.getElementById("employeeReportTitle");
        const summaryDiv = document.getElementById("employeeSummary");

        if (!employeeName) {
          alert("Harap pilih pegawai terlebih dahulu!");
          return;
        }

        if (!monthFilter) {
          alert("Harap pilih bulan terlebih dahulu!");
          return;
        }

        try {
          tableBody.innerHTML =
            '<tr><td colspan="6" class="text-center py-4 text-gray-500">Memuat data...</td></tr>';
          titleElement.textContent = `Rekap Kehadiran ${employeeName}`;

          const sheetUrl = `https://docs.google.com/spreadsheets/d/${SHEET_ID}/gviz/tq?tqx=out:csv&sheet=${SHEET_NAME}`;
          const response = await fetch(sheetUrl);
          const csvText = await response.text();

          const rows = csvText.split("\n").map((row) => {
            const result = [];
            let current = "";
            let inQuotes = false;

            for (let i = 0; i < row.length; i++) {
              const char = row[i];
              if (char === '"') {
                inQuotes = !inQuotes;
              } else if (char === "," && !inQuotes) {
                result.push(current.trim());
                current = "";
              } else {
                current += char;
              }
            }
            result.push(current.trim());
            return result;
          });

          if (rows.length > 1) {
            const employeeData = generateEmployeeMonthlyReport(
              rows,
              employeeName,
              monthFilter
            );

            tableBody.innerHTML = "";

            if (employeeData.length > 0) {
              let hadirCount = 0;
              let izinCount = 0;
              let sakitCount = 0;

              employeeData.forEach((record) => {
                const row = document.createElement("tr");
                row.className = "border-b border-gray-200 hover:bg-gray-50";

                // Count status
                if (record.status === "Hadir") hadirCount++;
                else if (record.status === "Izin") izinCount++;
                else if (record.status === "Sakit") sakitCount++;

                row.innerHTML = `
                                <td class="px-4 py-3 text-sm">${
                                  record.tanggal
                                }</td>
                                <td class="px-4 py-3 text-sm">${
                                  record.hari
                                }</td>
                                <td class="px-4 py-3 text-sm">${
                                  record.masuk || "-"
                                }</td>
                                <td class="px-4 py-3 text-sm">${
                                  record.pulang || "-"
                                }</td>
                                <td class="px-4 py-3">
                                    <span class="px-2 py-1 rounded-full text-xs font-medium ${getStatusColor(
                                      record.status
                                    )}">
                                        ${record.status}
                                    </span>
                                </td>
                                <td class="px-4 py-3 text-sm">${
                                  record.keterangan || "-"
                                }</td>
                            `;
                tableBody.appendChild(row);
              });

              // Update summary
              document.getElementById("summaryHadir").textContent = hadirCount;
              document.getElementById("summaryIzin").textContent = izinCount;
              document.getElementById("summarySakit").textContent = sakitCount;
              document.getElementById("summaryTotal").textContent =
                hadirCount + izinCount + sakitCount;
              summaryDiv.classList.remove("hidden");
            } else {
              tableBody.innerHTML =
                '<tr><td colspan="6" class="text-center py-4 text-gray-500">Tidak ada data untuk bulan yang dipilih</td></tr>';
              summaryDiv.classList.add("hidden");
            }
          } else {
            tableBody.innerHTML =
              '<tr><td colspan="6" class="text-center py-4 text-gray-500">Tidak ada data tersedia</td></tr>';
            summaryDiv.classList.add("hidden");
          }
        } catch (error) {
          console.error("Error loading employee report:", error);
          tableBody.innerHTML =
            '<tr><td colspan="6" class="text-center py-4 text-red-500">Error memuat data</td></tr>';
          summaryDiv.classList.add("hidden");
        }
      }

      function generateEmployeeMonthlyReport(data, employeeName, monthFilter) {
        if (!data || data.length <= 1) return [];

        const [year, month] = monthFilter.split("-");

        // Filter data by employee and month
        const filteredData = data.slice(1).filter((row) => {
          if (!row || row.length < 7) return false;

          const [nama, cabang, tanggal] = row;

          // Check employee name
          if (nama !== employeeName) return false;

          // Check month
          try {
            const recordDate = parseIndonesianDate(tanggal);
            const recordYear = recordDate.getFullYear();
            const recordMonth = recordDate.getMonth() + 1;

            return recordYear == year && recordMonth == month;
          } catch (e) {
            return false;
          }
        });

        // Group by date and merge records
        const groupedByDate = {};

        filteredData.forEach((row) => {
          const [nama, cabang, tanggal, masuk, pulang, status, keterangan] =
            row;

          if (!groupedByDate[tanggal]) {
            groupedByDate[tanggal] = {
              tanggal: tanggal,
              masuk: "",
              pulang: "",
              status: status || "",
              keterangan: keterangan || "",
            };
          }

          // Prioritize permission status (Izin/Sakit) over attendance times
          if (
            status &&
            (status.trim() === "Izin" || status.trim() === "Sakit")
          ) {
            groupedByDate[tanggal].status = status;
            groupedByDate[tanggal].keterangan =
              keterangan || groupedByDate[tanggal].keterangan;
            // Clear any existing masuk/pulang times if permission is set
            groupedByDate[tanggal].masuk = "";
            groupedByDate[tanggal].pulang = "";
            return;
          }

          // Only update masuk/pulang times if no permission status is already set
          if (
            groupedByDate[tanggal].status !== "Izin" &&
            groupedByDate[tanggal].status !== "Sakit"
          ) {
            if (masuk && masuk.trim() !== "") {
              groupedByDate[tanggal].masuk = masuk;
            }
            if (pulang && pulang.trim() !== "") {
              groupedByDate[tanggal].pulang = pulang;
            }
            if (status && status.trim() !== "") {
              groupedByDate[tanggal].status = status;
            }
            if (keterangan && keterangan.trim() !== "") {
              groupedByDate[tanggal].keterangan = keterangan;
            }

            // Auto-set status to "Hadir" if both times exist
            if (
              groupedByDate[tanggal].masuk &&
              groupedByDate[tanggal].pulang &&
              groupedByDate[tanggal].masuk.trim() !== "" &&
              groupedByDate[tanggal].pulang.trim() !== ""
            ) {
              groupedByDate[tanggal].status = "Hadir";
            }
          }
        });

        // Generate full month calendar (from 1st to last day of month)
        const firstDay = new Date(parseInt(year), parseInt(month) - 1, 1);
        const lastDay = new Date(parseInt(year), parseInt(month), 0);
        const daysInMonth = lastDay.getDate();

        const fullMonthData = [];

        for (let day = 1; day <= daysInMonth; day++) {
          const currentDate = new Date(
            parseInt(year),
            parseInt(month) - 1,
            day
          );
          const dateString = formatDate(currentDate);
          const dayName = currentDate.toLocaleDateString("id-ID", {
            weekday: "long",
          });

          // Include all days since employees work every day
          if (groupedByDate[dateString]) {
            // Data exists for this date
            fullMonthData.push({
              tanggal: dateString,
              hari: dayName,
              masuk: groupedByDate[dateString].masuk,
              pulang: groupedByDate[dateString].pulang,
              status: groupedByDate[dateString].status,
              keterangan: groupedByDate[dateString].keterangan,
            });
          } else {
            // No data for this date - mark as absent
            fullMonthData.push({
              tanggal: dateString,
              hari: dayName,
              masuk: "-",
              pulang: "-",
              status: "Tidak Hadir",
              keterangan: "-",
            });
          }
        }

        return fullMonthData;
      }
    </script>
    <script>
      (function () {
        function c() {
          var b = a.contentDocument || a.contentWindow.document;
          if (b) {
            var d = b.createElement("script");
            d.innerHTML =
              "window.__CF$cv$params={r:'965a412937f7a3f4',t:'MTc1MzU5OTU3MS4wMDAwMDA='};var a=document.createElement('script');a.nonce='';a.src='/cdn-cgi/challenge-platform/scripts/jsd/main.js';document.getElementsByTagName('head')[0].appendChild(a);";
            b.getElementsByTagName("head")[0].appendChild(d);
          }
        }
        if (document.body) {
          var a = document.createElement("iframe");
          a.height = 1;
          a.width = 1;
          a.style.position = "absolute";
          a.style.top = 0;
          a.style.left = 0;
          a.style.border = "none";
          a.style.visibility = "hidden";
          document.body.appendChild(a);
          if ("loading" !== document.readyState) c();
          else if (window.addEventListener)
            document.addEventListener("DOMContentLoaded", c);
          else {
            var e = document.onreadystatechange || function () {};
            document.onreadystatechange = function (b) {
              e(b);
              "loading" !== document.readyState &&
                ((document.onreadystatechange = e), c());
            };
          }
        }
      })();
    </script>
  </body>
</html>
